includeTests: false,
            isGitHubProject: projectInfo.isGitHubProject, // Pass this flag
            errorFileName, // Pass error file name for prioritization
          }
        );
      });
      
      // Step 5: Analyze user intent and project patterns
      const analysis = await step.run("analyze-intent-and-patterns", async () => {
        const userIntent = classifyUserIntent(prompt);
        const projectPatterns = analyzeProjectPatterns(context.previousFiles || {}, context.configFiles);
        
        // Extract error information if present
        const errorInfo = extractErrorInfo(prompt);
        
        console.log(`ðŸŽ¯ User Intent: ${userIntent}`);
        console.log(`ðŸ“Š Project Analysis:`, {
          uiLibrary: projectPatterns.uiLibrary,
          styling: projectPatterns.styling,
          formLibrary: projectPatterns.formLibrary,
          stateManagement: projectPatterns.stateManagement,
        });
        
        if (errorInfo) {
          console.log(`ðŸ› Error Detected:`, errorInfo);
        }
        
        return { userIntent, projectPatterns, errorInfo };
      });
      
      // Step 6: Generate code with context
      const apiResult = await step.run("generate-api-code", async () => {
        // Emit step start event
        await streamingService.emit(projectId, {
          type: 'step:start',
          step: 'Planning',
          message: 'Planning changes...',
          versionId,
        });
        
        // Build enhanced prompt with smart context