files: combinedFiles,
                requirements: requirements
              } as AgentState
            }
          };
          
          return result;
        } catch (error) {
          console.error("Failed to parse generated API code:", error);
          throw error;
        }
      });
      
      // Step 4: Apply changes to sandbox and restart dev server
      const sandboxUpdateResult = await step.run("apply-changes-to-sandbox", async () => {
        try {
          // Get project to find sandbox_id
          const { data: project } = await supabase
            .from('projects')
            .select('metadata, sandbox_url')
            .eq('id', projectId)